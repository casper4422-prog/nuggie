<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width,initial-scale=1">
        <title>ü¶ï Dino Nuggie Manager</title>
        <link rel="stylesheet" href="main.css">
        <link rel="stylesheet" href="main-additional.css">
    </head>
    <body>
        <!-- Tribe Settings Modal -->
        function loadSpeciesGrid() {
            console.log('Loading species grid...');
            
            // Clear any existing filters and show all species
            const searchInput = document.getElementById('searchInput');
            const categoryFilter = document.getElementById('categoryFilter');
            const rarityFilter = document.getElementById('rarityFilter');
            
            if (searchInput) searchInput.value = '';
            if (categoryFilter) categoryFilter.value = '';
            if (rarityFilter) rarityFilter.value = '';
            
            // Use the filter function to display all species
            filterSpecies();
        }

        function createSpeciesCard(species, creatureCount) {
            if (!species) {
                console.error('Species is null or undefined');
                return null;
            }
            
            if (!species.name || !species.icon || !species.rarity || !species.category) {
                console.error('Species missing required fields:', species);
                return null;
            }
            
            try {
                const card = document.createElement('div');
                card.className = 'species-card';
                card.onclick = () => openCreaturePage(species.name);

                // Get creatures for this species to calculate badges and stats
                const speciesCreatures = appState.creatures.filter(c => c.species === species.name);
                
                // Generate badges for this species
                let badgesHTML = '';
                let highestStatsHTML = '';
                
                if (speciesCreatures.length > 0) {
                    // Get highest stats for badge display
                    const highestStats = calculateHighestBaseStats(speciesCreatures);
                    
                    // Generate badges for creatures with achievements
                    const achievementCreatures = speciesCreatures.filter(creature => {
                        const badges = BadgeSystem.generateBadgeHTML(creature);
                        return badges && badges.trim() !== '';
                    });
                    
                    if (achievementCreatures.length > 0) {
                        badgesHTML = `
                            <div class="species-badges">
                                ${achievementCreatures.slice(0, 3).map(creature => 
                                    BadgeSystem.generateBadgeHTML(creature)
                                ).join('')}
                                ${achievementCreatures.length > 3 ? `<span class="badge-more">+${achievementCreatures.length - 3}</span>` : ''}
                            </div>
                        `;
                    }
                    
                    // Display highest stats for this species
                    highestStatsHTML = `
                        <div class="species-stats">
                            <div class="stat-row">
                                <span class="stat-icon">‚ù§Ô∏è</span>
                                <span class="stat-label">Health</span>
                                <span class="stat-value">${highestStats.Health?.value || 0}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-icon">üèÉ</span>
                                <span class="stat-label">Stamina</span>
                                <span class="stat-value">${highestStats.Stamina?.value || 0}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-icon">üí®</span>
                                <span class="stat-label">Oxygen</span>
                                <span class="stat-value">${highestStats.Oxygen?.value || 0}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-icon">üçñ</span>
                                <span class="stat-label">Food</span>
                                <span class="stat-value">${highestStats.Food?.value || 0}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-icon">‚öñÔ∏è</span>
                                <span class="stat-label">Weight</span>
                                <span class="stat-value">${highestStats.Weight?.value || 0}</span>
                            </div>
                            <div class="stat-row">
                                <span class="stat-icon">‚öîÔ∏è</span>
                                <span class="stat-label">Melee</span>
                                <span class="stat-value">${highestStats.Melee?.value || 0}</span>
                            </div>
                        </div>
                    `;
                }

                card.innerHTML = `
                    <div class="species-header">
                        <div class="species-icon">${species.icon}</div>
                        <div class="rarity-badge rarity-${species.rarity}">${species.rarity}</div>
                        <div class="creature-count">
                            <span>ü¶¥</span>
                            <span>${creatureCount} creatures</span>
                        </div>
                    </div>
                    <div class="species-content">
                        <div class="species-name">${species.name}</div>
                        <div class="species-category">${species.category}</div>
                        ${badgesHTML}
                        ${highestStatsHTML}
                        <div class="species-description">${species.description || 'No description available'}</div>
                    </div>
                `;

                return card;
            } catch (error) {
                console.error('Error creating species card for', species.name, ':', error);
                return null;
            }
        }

        function filterSpecies() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value.toLowerCase();
            const rarityFilter = document.getElementById('rarityFilter').value.toLowerCase();
            
            const grid = document.getElementById('speciesGrid');
            
            if (!grid) {
                console.error('Species grid element not found');
                return;
            }
            
            if (!SPECIES_DATABASE) {
                console.error('Species database not found');
                return;
            }
            
            grid.innerHTML = '';
            console.log('Filtering species with:', { searchTerm, categoryFilter, rarityFilter });

            let filteredCount = 0;
            Object.values(SPECIES_DATABASE).forEach(species => {
                if (!species || !species.name) {
                    return;
                }
                
                // Apply search filter
                const matchesSearch = !searchTerm || 
                    species.name.toLowerCase().includes(searchTerm) ||
                    (species.category && species.category.toLowerCase().includes(searchTerm)) ||
                    (species.diet && species.diet.toLowerCase().includes(searchTerm)) ||
                    (species.description && species.description.toLowerCase().includes(searchTerm));
                
                // Apply category filter
                let matchesCategory = false;
                if (!categoryFilter) {
                    matchesCategory = true;
                } else if (categoryFilter === 'flyer') {
                    matchesCategory = species.speeds && species.speeds.flying && species.speeds.flying > 0;
                    if (matchesCategory) {
                        console.log('Found flyer:', species.name, 'flying speed:', species.speeds.flying);
                    }
                } else {
                    matchesCategory = (species.category && species.category.toLowerCase() === categoryFilter) ||
                                    (species.diet && species.diet.toLowerCase() === categoryFilter);
                }
                
                // Apply rarity filter
                const matchesRarity = !rarityFilter || 
                    (species.rarity && species.rarity.toLowerCase() === rarityFilter);
                
                // Show species if it matches all filters
                if (matchesSearch && matchesCategory && matchesRarity) {
                    const creatureCount = appState.creatures.filter(c => c.species === species.name).length;
                    const card = createSpeciesCard(species, creatureCount);
                    if (card) {
                        grid.appendChild(card);
                        filteredCount++;
                    }
                }
            });

            console.log(`Filtered species: showing ${filteredCount} species`);
            
            if (filteredCount === 0) {
                grid.innerHTML = '<p class="no-species-found">No species found matching your filters.</p>';
            }
        }

        // Creature Page Management
        function openCreaturePage(speciesName) {
            appState.currentSpecies = speciesName;
            const species = SPECIES_DATABASE[speciesName];
            
            document.getElementById('creaturePageIcon').textContent = species.icon;
            document.getElementById('creaturePageTitle').textContent = species.name;
            
            const creatures = appState.creatures.filter(c => c.species === speciesName);
            document.getElementById('creaturePageMeta').textContent = `${creatures.length} creatures`;
            
            // Populate species information
            populateSpeciesInfo(species);
            
            // Initialize view preference
            const savedViewType = localStorage.getItem('creatureViewType') || 'card';
            switchCreatureView(savedViewType);
            
            document.getElementById('speciesPage').style.display = 'none';
            document.getElementById('creaturePage').style.display = 'block';
        }

        // Tab Management
        function switchTab(tabId) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            document.getElementById(tabId).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }

        // Populate Species Information
        function populateSpeciesInfo(species) {
            // Basic Info Tab
            document.getElementById('species-dossier').textContent = species.dossierText || 'No dossier available.';
            document.getElementById('species-temperament').textContent = species.temperament || 'Unknown';
            document.getElementById('species-diet').textContent = species.diet || 'Unknown';
            document.getElementById('species-habitat').textContent = species.habitat || 'Unknown';
            document.getElementById('species-basis').textContent = species.realWorldBasis || 'Unknown';
            document.getElementById('species-rarity').textContent = species.rarity || 'Unknown';
            document.getElementById('species-source').textContent = species.source || 'Unknown';
            
            // Stats & Combat Tab
            populateBaseStats(species.baseStats);
            document.getElementById('species-attacks').textContent = species.attackTypes ? species.attackTypes.join(', ') : 'None';
            document.getElementById('species-abilities').textContent = species.specialAbilities ? species.specialAbilities.join(', ') : 'None';
            
            if (species.speeds) {
                document.getElementById('species-land-speed').textContent = species.speeds.land || 'N/A';
                document.getElementById('species-flying-speed').textContent = species.speeds.flying || 'N/A';
                document.getElementById('species-swimming-speed').textContent = species.speeds.swimming || 'N/A';
            }
            
            // Taming Info Tab
            document.getElementById('species-taming-method').textContent = species.tamingMethod || 'Unknown';
            document.getElementById('species-kibble').textContent = species.preferredKibble || 'Unknown';
            document.getElementById('species-food').textContent = species.favoriteFood || 'Unknown';
            document.getElementById('species-taming-speed').textContent = species.tamingSpeed || 'Unknown';
            document.getElementById('species-torpor').textContent = species.torpor?.baseValue || 'Unknown';
            document.getElementById('species-requirements').textContent = species.specialRequirements || 'None';
            
            // Utility & Roles Tab
            document.getElementById('species-primary-role').textContent = species.primaryRole || 'Unknown';
            document.getElementById('species-secondary-roles').textContent = species.secondaryRoles ? species.secondaryRoles.join(', ') : 'None';
            
            populateResourceList(species.gatheringResources);
            populateAbilitiesList(species.specialAbilities);
            document.getElementById('species-workstation').textContent = species.workstation || 'None';
            
            // Environment Tab
            document.getElementById('species-biomes').textContent = species.preferredBiome || 'Unknown';
            
            if (species.temperatureRange) {
                document.getElementById('species-temperature').textContent = `${species.temperatureRange.min}¬∞C - ${species.temperatureRange.max}¬∞C`;
            } else {
                document.getElementById('species-temperature').textContent = 'Unknown';
            }
            
            document.getElementById('species-resistances').textContent = species.environmentalResistances ? species.environmentalResistances.join(', ') : 'None';
            
            // Management Tab
            document.getElementById('species-difficulty').textContent = species.difficultyRating || 'Unknown';
            document.getElementById('species-beginner').textContent = species.beginnerFriendly ? 'Yes' : 'No';
            document.getElementById('species-investment').textContent = species.resourceInvestment || 'Unknown';
            document.getElementById('species-maintenance').textContent = species.maintenanceLevel || 'Unknown';
            document.getElementById('species-boss-capable').textContent = species.bossFightCapable ? 'Yes' : 'No';
            document.getElementById('species-endgame').textContent = species.endGameViable ? 'Yes' : 'No';
        }

        function populateBaseStats(baseStats) {
            const statsContainer = document.getElementById('species-base-stats');
            statsContainer.innerHTML = '';
            
            if (!baseStats) {
                statsContainer.innerHTML = '<div class="stat-no-data">No stats available</div>';
                return;
            }
            
            const statNames = {
                health: 'Health',
                stamina: 'Stamina',
                oxygen: 'Oxygen',
                food: 'Food',
                weight: 'Weight',
                melee: 'Melee',
                speed: 'Speed',
                torpor: 'Torpor'
            };
            
            Object.entries(baseStats).forEach(([key, value]) => {
                if (statNames[key]) {
                    const statElement = document.createElement('div');
                    statElement.className = 'stat-item';
                    statElement.innerHTML = `
                        <div class="stat-name">${statNames[key]}</div>
                        <div class="stat-value">${value}</div>
                    `;
                    statsContainer.appendChild(statElement);
                }
            });
        }

        function populateResourceList(resources) {
            const container = document.getElementById('species-resources');
            container.innerHTML = '';
            
            if (!resources || resources.length === 0) {
                container.innerHTML = '<div class="stat-no-data">No special resource gathering</div>';
                return;
            }
            
            resources.forEach(resource => {
                const tag = document.createElement('div');
                tag.className = 'resource-tag';
                tag.textContent = resource;
                container.appendChild(tag);
            });
        }

        function populateAbilitiesList(abilities) {
            const container = document.getElementById('species-special-abilities');
            container.innerHTML = '';
            
            if (!abilities || abilities.length === 0) {
                container.innerHTML = '<div class="stat-no-data">No special abilities</div>';
                return;
            }
            
            abilities.forEach(ability => {
                const tag = document.createElement('div');
                tag.className = 'ability-tag';
                tag.textContent = ability;
                container.appendChild(tag);
            });
        }

        function goBackToSpecies() {
            appState.currentSpecies = null;
            document.getElementById('creaturePage').style.display = 'none';
            document.getElementById('speciesPage').style.display = 'block';
            loadSpeciesGrid();
        }

        // View switching functionality
        function switchCreatureView(viewType) {
            const grid = document.getElementById('creaturesGrid');
            const cardBtn = document.getElementById('cardViewBtn');
            const listBtn = document.getElementById('listViewBtn');
            
            // Update button states
            cardBtn.classList.toggle('active', viewType === 'card');
            listBtn.classList.toggle('active', viewType === 'list');
            
            // Update grid class
            if (viewType === 'list') {
                grid.classList.add('list-view');
            } else {
                grid.classList.remove('list-view');
            }
            
            // Save preference
            localStorage.setItem('creatureViewType', viewType);
            
            // Reload creatures with new view
            loadCreaturesGrid();
        }

        function loadCreaturesGrid() {
            const grid = document.getElementById('creaturesGrid');
            const creatures = appState.creatures.filter(c => c.species === appState.currentSpecies);
            
            if (creatures.length === 0) {
                grid.innerHTML = `
                    <div class="no-creatures">
                        <div class="no-creatures-icon">ü¶¥</div>
                        <div class="no-creatures-yet">No creatures yet</div>
                        <div>Add your first creature to start tracking this species!</div>
                    </div>
                `;
                return;
            }

            // Calculate highest base stats for this species
            const highestStats = calculateHighestBaseStats(creatures);
            
            grid.innerHTML = '';
            creatures.forEach(creature => {
                const card = createCreatureCard(creature, highestStats);
                grid.appendChild(card);
            });
        }

        function calculateHighestBaseStats(creatures) {
            const stats = ['Health', 'Stamina', 'Oxygen', 'Food', 'Weight', 'Melee'];
            const highest = {};
            
            // Ensure we have valid creatures array
            if (!creatures || creatures.length === 0) {
                return highest;
            }
            
            stats.forEach(stat => {
                let maxValue = 0;
                let maxCreatureId = null;
                
                creatures.forEach(creature => {
                    // Ensure creature and baseStats exist
                    if (!creature || !creature.baseStats) {
                        return;
                    }
                    
                    const baseValue = creature.baseStats[stat] || 0;
                    if (baseValue > maxValue) {
                        maxValue = baseValue;
                        maxCreatureId = creature.id;
                    }
                });
                
                highest[stat] = {
                    value: maxValue,
                    creatureId: maxCreatureId
                };
            });
            
            return highest;
        }

        function createCreatureCard(creature, highestStats = {}) {
            const card = document.createElement('div');
            card.className = 'creature-card';
            card.onclick = () => openCreatureDetailModal(creature);

            const badgeHTML = BadgeSystem.generateBadgeHTML(creature);
            
            // Format stats for display
            const healthDisplay = BadgeSystem.formatStatDisplay(
                creature.baseStats?.Health, 
                creature.mutations?.Health, 
                creature.domesticLevels?.Health
            );
            const staminaDisplay = BadgeSystem.formatStatDisplay(
                creature.baseStats?.Stamina, 
                creature.mutations?.Stamina, 
                creature.domesticLevels?.Stamina
            );
            const oxygenDisplay = BadgeSystem.formatStatDisplay(
                creature.baseStats?.Oxygen, 
                creature.mutations?.Oxygen, 
                creature.domesticLevels?.Oxygen
            );
            const foodDisplay = BadgeSystem.formatStatDisplay(
                creature.baseStats?.Food, 
                creature.mutations?.Food, 
                creature.domesticLevels?.Food
            );
            const weightDisplay = BadgeSystem.formatStatDisplay(
                creature.baseStats?.Weight, 
                creature.mutations?.Weight, 
                creature.domesticLevels?.Weight
            );
            const meleeDisplay = BadgeSystem.formatStatDisplay(
                creature.baseStats?.Melee, 
                creature.mutations?.Melee, 
                creature.domesticLevels?.Melee
            );

            // Helper function to check if stat is highest
            const isHighestStat = (statName) => {
                if (!highestStats || !highestStats[statName] || !creature || !creature.id) {
                    return false;
                }
                return highestStats[statName].creatureId === creature.id;
            };

            // Check if we're in list view
            const grid = document.getElementById('creaturesGrid');
            const isListView = grid && grid.classList.contains('list-view');

            if (isListView) {
                // List view layout
                card.innerHTML = `
                    <div class="creature-card-header">
                        ${creature.image ? 
                            `<img src="${creature.image}" alt="${creature.name}" class="creature-image creature-image-list">` :
                            `<div class="creature-image-placeholder creature-image-list-placeholder">${SPECIES_DATABASE[creature.species]?.icon || 'ü¶ñ'}</div>`
                        }
                    </div>
                    <div class="creature-card-content">
                        <div class="creature-name">${creature.name}</div>
                        <div class="creature-meta">
                            <div class="list-view-stat">
                                <span>üìä</span>
                                <span>Lvl ${creature.level || 1}</span>
                            </div>
                            <div class="list-view-stat">
                                <span>${creature.gender === 'Male' ? '‚ôÇÔ∏è' : creature.gender === 'Female' ? '‚ôÄÔ∏è' : '‚ùì'}</span>
                                <span>${creature.gender || 'Unknown'}</span>
                            </div>
                            <div class="list-view-stat ${isHighestStat('Health') ? 'highest-stat' : ''}">
                                <span>‚ù§Ô∏è</span>
                                <span>${healthDisplay}</span>
                            </div>
                            <div class="list-view-stat ${isHighestStat('Stamina') ? 'highest-stat' : ''}">
                                <span>üèÉ</span>
                                <span>${staminaDisplay}</span>
                            </div>
                            <div class="list-view-stat ${isHighestStat('Oxygen') ? 'highest-stat' : ''}">
                                <span>üí®</span>
                                <span>${oxygenDisplay}</span>
                            </div>
                            <div class="list-view-stat ${isHighestStat('Food') ? 'highest-stat' : ''}">
                                <span>üçñ</span>
                                <span>${foodDisplay}</span>
                            </div>
                            <div class="list-view-stat ${isHighestStat('Weight') ? 'highest-stat' : ''}">
                                <span>‚öñÔ∏è</span>
                                <span>${weightDisplay}</span>
                            </div>
                            <div class="list-view-stat ${isHighestStat('Melee') ? 'highest-stat' : ''}">
                                <span>‚öîÔ∏è</span>
                                <span>${meleeDisplay}</span>
                            </div>
                        </div>
                        <div class="creature-badges">
                            ${badgeHTML}
                        </div>
                    </div>
                `;
            } else {
                // Card view layout (existing)
                card.innerHTML = `
                    <div class="creature-card-header">
                        ${creature.image ? 
                            `<img src="${creature.image}" alt="${creature.name}" class="creature-image">` :
                            `<div class="creature-image-placeholder">${SPECIES_DATABASE[creature.species]?.icon || 'ü¶ñ'}</div>`
                        }
                        <div class="creature-badges">
                            ${badgeHTML}
                        </div>
                    </div>
                    <div class="creature-card-content">
                        <div class="creature-name">${creature.name}</div>
                        <div class="creature-meta">
                            <span>Level ${creature.level || 1}</span>
                            <span>${creature.gender || 'Unknown'}</span>
                        </div>
                        <div class="creature-stats">
                            <div class="stat-item ${isHighestStat('Health') ? 'highest-stat' : ''}">
                                <div class="stat-label"><span class="stat-icon">‚ù§Ô∏è</span> Health</div>
                                <div class="stat-value">${healthDisplay}</div>
                            </div>
                            <div class="stat-item ${isHighestStat('Stamina') ? 'highest-stat' : ''}">
                                <div class="stat-label"><span class="stat-icon">üèÉ</span> Stamina</div>
                                <div class="stat-value">${staminaDisplay}</div>
                            </div>
                            <div class="stat-item ${isHighestStat('Oxygen') ? 'highest-stat' : ''}">
                                <div class="stat-label"><span class="stat-icon">üí®</span> Oxygen</div>
                                <div class="stat-value">${oxygenDisplay}</div>
                            </div>
                            <div class="stat-item ${isHighestStat('Food') ? 'highest-stat' : ''}">
                                <div class="stat-label"><span class="stat-icon">üçñ</span> Food</div>
                                <div class="stat-value">${foodDisplay}</div>
                            </div>
                            <div class="stat-item ${isHighestStat('Weight') ? 'highest-stat' : ''}">
                                <div class="stat-label"><span class="stat-icon">‚öñÔ∏è</span> Weight</div>
                                <div class="stat-value">${weightDisplay}</div>
                            </div>
                            <div class="stat-item ${isHighestStat('Melee') ? 'highest-stat' : ''}">
                                <div class="stat-label"><span class="stat-icon">‚öîÔ∏è</span> Melee</div>
                                <div class="stat-value">${meleeDisplay}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            return card;
        }

        // Creature Modal Management
        function openCreatureModal(creature = null) {
            appState.editingCreature = creature?.id || null;
            
            // Reset form
            document.getElementById('creatureName').value = creature?.name || '';
            document.getElementById('creatureGender').value = creature?.gender || 'Male';
            document.getElementById('creatureLevel').value = creature?.level || '';
            
            // Base stats
            document.getElementById('baseStatHealth').value = creature?.baseStats?.Health || '';
            document.getElementById('baseStatStamina').value = creature?.baseStats?.Stamina || '';
            document.getElementById('baseStatOxygen').value = creature?.baseStats?.Oxygen || '';
            document.getElementById('baseStatFood').value = creature?.baseStats?.Food || '';
            document.getElementById('baseStatWeight').value = creature?.baseStats?.Weight || '';
            document.getElementById('baseStatMelee').value = creature?.baseStats?.Melee || '';
            
            // Mutations
            document.getElementById('healthMutations').value = creature?.mutations?.Health || '';
            document.getElementById('staminaMutations').value = creature?.mutations?.Stamina || '';
            document.getElementById('oxygenMutations').value = creature?.mutations?.Oxygen || '';
            document.getElementById('foodMutations').value = creature?.mutations?.Food || '';
            document.getElementById('weightMutations').value = creature?.mutations?.Weight || '';
            document.getElementById('meleeMutations').value = creature?.mutations?.Melee || '';
            
            // Domestic levels
            document.getElementById('healthLevels').value = creature?.domesticLevels?.Health || '';
            document.getElementById('staminaLevels').value = creature?.domesticLevels?.Stamina || '';
            document.getElementById('oxygenLevels').value = creature?.domesticLevels?.Oxygen || '';
            document.getElementById('foodLevels').value = creature?.domesticLevels?.Food || '';
            document.getElementById('weightLevels').value = creature?.domesticLevels?.Weight || '';
            document.getElementById('meleeLevels').value = creature?.domesticLevels?.Melee || '';
            
            document.getElementById('creatureNotes').value = creature?.notes || '';
            
            // Handle image
            const imagePreview = document.getElementById('imagePreview');
            if (creature?.image) {
                imagePreview.innerHTML = `<img src="${creature.image}" alt="Preview" class="image-upload-preview">`;
            } else {
                imagePreview.innerHTML = `
                    <div>üì∑</div>
                    <div class="upload-image-label">Upload Image</div>
                `;
            }
            
            document.getElementById('creatureModalTitle').textContent = creature ? 'Edit Creature' : 'Add Creature';
            document.getElementById('creatureModal').classList.add('active');
            updateBadgePreview();
        }

        function closeCreatureModal() {
            document.getElementById('creatureModal').classList.remove('active');
            appState.editingCreature = null;
        }

        function handleImageUpload(input) {
          const file = input.files[0];
          const imagePreview = document.getElementById('imagePreview');
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              const result = e.target.result;
              if (typeof result === 'string' && result.startsWith('data:image')) {
                imagePreview.innerHTML = `<img src="${result}" alt="Preview" class="image-upload-preview">`;
              } else {
                imagePreview.innerHTML = `<div>üì∑</div><div class="upload-image-label">Upload Image</div>`;
              }
            };
            reader.readAsDataURL(file);
          } else {
            imagePreview.innerHTML = `<div>üì∑</div><div class="upload-image-label">Upload Image</div>`;
          }
        }

        function updateBadgePreview() {
            const creature = {
                baseStats: {
                    Health: parseInt(document.getElementById('baseStatHealth').value) || 0,
                    Stamina: parseInt(document.getElementById('baseStatStamina').value) || 0,
                    Food: parseInt(document.getElementById('baseStatFood').value) || 0,
                    Weight: parseInt(document.getElementById('baseStatWeight').value) || 0,
                    Melee: parseInt(document.getElementById('baseStatMelee').value) || 0
                }
            };

            const bloodline = BadgeSystem.calculatePrizedBloodline(creature);
            const previewContent = document.getElementById('badgePreviewContent');
            
            if (bloodline.qualified) {
                const badgeClass = `badge-${bloodline.tier}`;
                previewContent.innerHTML = `
                    <div class="badge ${badgeClass}">${bloodline.tier.toUpperCase()} BLOODLINE</div>
                    <span class="stat-info">Minimum stat: ${bloodline.minStat} points</span>
                `;
            } else {
                previewContent.innerHTML = `
                    <span class="no-badge-qualification">No badge qualification yet</span>
                    <span class="stat-info">‚Ä¢ Need all 5 core stats ‚â•45 for Bronze</span>
                `;
            }
        }

        function saveCreature() {
            const name = document.getElementById('creatureName').value.trim();
            if (!name) {
                alert('Please enter a creature name');
                return;
            }

            const imageInput = document.getElementById('creatureImage');
            const imageElement = document.querySelector('#imagePreview img');
            
            const creatureData = {
                id: appState.editingCreature || generateId(),
                name,
                species: appState.currentSpecies,
                gender: document.getElementById('creatureGender').value,
                level: parseInt(document.getElementById('creatureLevel').value) || 1,
                image: imageElement ? imageElement.src : null,
                baseStats: {
                    Health: parseInt(document.getElementById('baseStatHealth').value) || 0,
                    Stamina: parseInt(document.getElementById('baseStatStamina').value) || 0,
                    Oxygen: parseInt(document.getElementById('baseStatOxygen').value) || 0,
                    Food: parseInt(document.getElementById('baseStatFood').value) || 0,
                    Weight: parseInt(document.getElementById('baseStatWeight').value) || 0,
                    Melee: parseInt(document.getElementById('baseStatMelee').value) || 0
                },
                mutations: {
                    Health: parseInt(document.getElementById('healthMutations').value) || 0,
                    Stamina: parseInt(document.getElementById('staminaMutations').value) || 0,
                    Oxygen: parseInt(document.getElementById('oxygenMutations').value) || 0,
                    Food: parseInt(document.getElementById('foodMutations').value) || 0,
                    Weight: parseInt(document.getElementById('weightMutations').value) || 0,
                    Melee: parseInt(document.getElementById('meleeMutations').value) || 0
                },
                domesticLevels: {
                    Health: parseInt(document.getElementById('healthLevels').value) || 0,
                    Stamina: parseInt(document.getElementById('staminaLevels').value) || 0,
                    Oxygen: parseInt(document.getElementById('oxygenLevels').value) || 0,
                    Food: parseInt(document.getElementById('foodLevels').value) || 0,
                    Weight: parseInt(document.getElementById('weightLevels').value) || 0,
                    Melee: parseInt(document.getElementById('meleeLevels').value) || 0
                },
                notes: document.getElementById('creatureNotes').value,
                createdAt: appState.editingCreature ? 
                    appState.creatures.find(c => c.id === appState.editingCreature)?.createdAt || new Date().toISOString() :
                    new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (appState.editingCreature) {
                const index = appState.creatures.findIndex(c => c.id === appState.editingCreature);
                appState.creatures[index] = creatureData;
            } else {
                appState.creatures.push(creatureData);
            }

            saveData();
            closeCreatureModal();
            loadCreaturesGrid();
            loadSpeciesGrid();
            updateStatsDashboard();
        }

        // Creature Detail Modal
        function openCreatureDetailModal(creature) {
            appState.selectedCreature = creature;
            document.getElementById('creatureDetailTitle').textContent = creature.name;
            
            const badges = BadgeSystem.generateBadgeHTML(creature);
            const species = SPECIES_DATABASE[creature.species];
            
            document.getElementById('creatureDetailContent').innerHTML = `
                <div class="creature-detail-header">
                    <div class="creature-detail-image-col">
                        ${creature.image ? 
                            `<img src="${creature.image}" alt="${creature.name}" class="creature-detail-image">` :
                            `<div class="creature-detail-image-placeholder">${species?.icon || 'ü¶ñ'}</div>`
                        }
                    </div>
                    <div class="creature-detail-content-col">
                        <div class="creature-detail-title-row">
                            <h3 class="creature-detail-title">${creature.name}</h3>
                            <span class="creature-gender-badge">${creature.gender || 'Unknown'}</span>
                        </div>
                        <div class="creature-detail-badges-row">
                            ${badges}
                        </div>
                        <div class="creature-detail-meta">
                            <strong>Species:</strong> ${creature.species} ‚Ä¢ 
                            <strong>Level:</strong> ${creature.level || 1}
                        </div>
                        ${creature.notes ? `<div class="creature-detail-notes"><strong>Notes:</strong> ${creature.notes}</div>` : ''}
                    </div>
                </div>
                
                <div class="creature-detail-stats-grid">
                    <div>
                        <h4 class="creature-detail-stats-title">üìä Base Stats</h4>
                        ${generateStatTable(creature.baseStats)}
                    </div>
                    <div>
                        <h4 class="creature-detail-stats-title">üß¨ Mutations</h4>
                        ${generateStatTable(creature.mutations)}
                    </div>
                </div>
                
                <div class="creature-detail-domestic">
                    <h4 class="creature-detail-stats-title">üìà Domestic Levels</h4>
                    ${generateStatTable(creature.domesticLevels)}
                </div>
            `;
            
            document.getElementById('creatureDetailModal').classList.add('active');
        }

        function generateStatTable(stats) {
            if (!stats) return '<div class="stat-no-data">No data</div>';
            
            return `
                <div class="stat-table-grid">
                    ${Object.entries(stats).map(([stat, value]) => `
                        <div class="stat-table-cell">
                            <div class="stat-table-label">${stat}</div>
                            <div class="stat-table-value">${value || 0}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function closeCreatureDetailModal() {
            document.getElementById('creatureDetailModal').classList.remove('active');
            appState.selectedCreature = null;
        }

        function editCreature() {
            closeCreatureDetailModal();
            openCreatureModal(appState.selectedCreature);
        }

        function deleteCreature() {
            if (confirm(`Are you sure you want to delete ${appState.selectedCreature.name}?`)) {
                appState.creatures = appState.creatures.filter(c => c.id !== appState.selectedCreature.id);
                saveData();
                closeCreatureDetailModal();
                loadCreaturesGrid();
                loadSpeciesGrid();
                updateStatsDashboard();
            }
        }

        // Stats Dashboard
        function updateStatsDashboard() {
            const creatures = appState.creatures;
            const speciesCount = new Set(creatures.map(c => c.species)).size;
            const prizedCount = creatures.filter(c => BadgeSystem.calculatePrizedBloodline(c).qualified).length;
            const highestLevel = creatures.length > 0 ? Math.max(...creatures.map(c => c.level || 1)) : 1;
            
            document.getElementById('totalCreatures').textContent = creatures.length;
            document.getElementById('speciesTracked').textContent = speciesCount;
            document.getElementById('bossReadySpecies').textContent = '0'; // Placeholder
            document.getElementById('prizedBloodlines').textContent = prizedCount;
            document.getElementById('highestLevel').textContent = highestLevel;
        }

        // Data Management
        function generateId() {
            return 'creature_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function saveData() {
            localStorage.setItem('arkCreatures', JSON.stringify(appState.creatures));
        }

        // Initialize the application
  // Only use new SPA navigation logic
    </script>
</script>
<script src="main.js"></script>
</body>
</html>